<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Konu YÃ¶netimi</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <div class="page">

    <div class="intro">
      <h1>Konu YÃ¶netimi</h1>
      <p>Konu ekle, dÃ¼zenle, sil. Ana sayfa otomatik gÃ¼ncellenecek.</p>
      <a href="index.html">â† Ana sayfaya dÃ¶n</a>
    </div>

    <!-- âœ… FORM -->
<form id="form" class="card form" style="width:min(900px,92vw); margin:20px auto;">
      <input type="hidden" id="topicId" value="" />

      <label>BaÅŸlÄ±k</label>
      <input id="title" required placeholder="Ã–rn: Docker Compose PratiÄŸi" />

      <label>Durum</label>
      <select id="status">
        <option value="done">Ã–ÄŸrendim</option>
        <option value="now" selected>Ã–ÄŸreniyorum</option>
        <option value="next">PlanlÄ±yorum</option>
      </select>

      <label>Ä°lerleme (%)</label>
      <input id="progress" type="number" min="0" max="100" value="0" />

      <label>Tahmini sÃ¼re (dk)</label>
      <input id="minutes" type="number" min="0" step="5" value="0" />

      <!-- âœ… SENÄ°N EKLEYECEÄÄ°N -->
      <label>BugÃ¼n kaÃ§ dk Ã§alÄ±ÅŸtÄ±m?</label>
      <input id="spent" type="number" min="0" step="5" placeholder="Ã–rn: 25" />

      <label>KÄ±sa aÃ§Ä±klama</label>
      <input id="short" placeholder="1 satÄ±rlÄ±k aÃ§Ä±klama" />

      <label>Detaylar (her satÄ±ra bir madde)</label>
      <textarea id="details" rows="4" placeholder="madde 1&#10;madde 2"></textarea>

      <label>Etiketler (virgÃ¼lle)</label>
      <input id="tags" placeholder="docker, devops, backend" />

      <div style="display:flex;gap:10px;margin-top:12px;">
        <button id="saveBtn" type="submit">Kaydet</button>
        <button id="cancelEdit" type="button">Ä°ptal</button>
      </div>
    </form>

    <!-- âœ… LÄ°STE -->
<div id="list" style="width:min(900px,92vw); margin:0 auto;"></div>

  </div>

  <!-- âœ… SCRIPT -->
  <script type="module">
    import { loadTopics, saveTopics, normalizeTopic, uid } from "./app.js";

    const el = (id) => document.getElementById(id);

    const form = el("form");
    const listEl = el("list");

    const topicIdEl = el("topicId");
    const titleEl = el("title");
    const statusEl = el("status");
    const progressEl = el("progress");
    const minutesEl = el("minutes");
    const spentEl = el("spent");
    const shortEl = el("short");
    const detailsEl = el("details");
    const tagsEl = el("tags");

    const cancelEditBtn = el("cancelEdit");

    function clearForm() {
      topicIdEl.value = "";
      titleEl.value = "";
      statusEl.value = "now";
      progressEl.value = 0;
      minutesEl.value = 0;
      spentEl.value = "";   // âœ… Ã¶nemli
      shortEl.value = "";
      detailsEl.value = "";
      tagsEl.value = "";
    }

    function renderList() {
      const topics = loadTopics();
      listEl.innerHTML = topics.map(t => `
        <div class="card ${t.status}" style="margin:10px auto;max-width:900px;">
          <h3>${t.title}</h3>
          <div style="opacity:.8;font-size:13px;">
            Durum: ${t.status} â€¢ %${t.progress} â€¢ SÃ¼re: ${t.minutes || 0}dk â€¢ Harcanan: ${t.spent || 0}dk
          </div>
        <div class="row-actions">
  <button class="btn btn-edit" data-edit="${t.id}" type="button">âœï¸ DÃ¼zenle</button>
  <button class="btn btn-del" data-del="${t.id}" type="button">ğŸ—‘ï¸ Sil</button>
</div>

        </div>
      `).join("");

      // buton olaylarÄ±
      listEl.querySelectorAll("[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.edit;
          const topics = loadTopics();
          const t = topics.find(x => x.id === id);
          if (!t) return;

          topicIdEl.value = t.id;
          titleEl.value = t.title || "";
          statusEl.value = t.status || "now";
          progressEl.value = t.progress ?? 0;
          minutesEl.value = t.minutes ?? 0;
          spentEl.value = ""; // âœ… â€œbugÃ¼nâ€ inputu her seferinde boÅŸ
          shortEl.value = t.short || "";
          detailsEl.value = (t.details || []).join("\n");
          tagsEl.value = (t.tags || []).join(", ");
          window.scrollTo({ top: 0, behavior: "smooth" });
        });
      });

      listEl.querySelectorAll("[data-del]").forEach(btn => {
        btn.addEventListener("click", () => {
          const id = btn.dataset.del;
          const topics = loadTopics().filter(x => x.id !== id);
          saveTopics(topics);
          renderList();
        });
      });
    }

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const topics = loadTopics();
      const id = topicIdEl.value || uid();

      const base = {
        id,
        title: titleEl.value,
        status: statusEl.value,
        progress: Number(progressEl.value || 0),
        minutes: Number(minutesEl.value || 0),
        short: shortEl.value,
        details: detailsEl.value.split("\n").map(s => s.trim()).filter(Boolean),
        tags: tagsEl.value.split(",").map(s => s.trim()).filter(Boolean),
      };

      // âœ… BUGÃœN Ã‡ALIÅILAN DAKÄ°KAYI BÄ°RÄ°KTÄ°R
const addRaw = spentEl.value === "" ? 0 : Number(spentEl.value);
const add = Number.isFinite(addRaw) ? Math.max(0, addRaw) : 0;
      base.spent = (topics.find(x => x.id === id)?.spent || 0) + add;
// EÄŸer "Ã–ÄŸrendim" seÃ§ildiyse: progress=100 ve spent=minutes olsun
if (base.status === "done") {
  base.progress = 100;
  base.spent = base.minutes; 
}

      const topic = normalizeTopic(base);

      const i = topics.findIndex(x => x.id === id);
      if (i >= 0) topics[i] = topic;
      else topics.push(topic);

      saveTopics(topics);
      clearForm();
      renderList();
    });

    cancelEditBtn.addEventListener("click", clearForm);

    renderList();
  </script>
</body>
</html>
